# pdf-remove-watermarks

__09.2020 - 02.2021__

[Adobe PDF Reference Archives](https://www.adobe.com/devnet/pdf/pdf_reference_archive.html)


Ланит
-----

Столкнулся с добавлением в хорошие файлы логотипов Ланит - по 2 штуки на страницу.

В разных файлах были добавлены по разному, но вылечилось отрезанием остатка из контекста страницы.
В конец были дописаны отображение чего-то. Конец определял по последнему вхождению ET.

После этого при оптимизации файла в Acrobat DC удаляются неиспользуемые картинки и ссылки.

Обработаны следующие файлы:

1. Курт - Программируй на Haskell.2019.pdf - уменьшение размера в 4 раза с 8мб до 2,5мб.
2. Вейн - Swift.Подробно.2020

```bash
remove_lanit.pl file.pdf [out.pdf] [first_page]
```
Ланит
-----

Тот же Ланит, но контент состоит из массива из 3 стримов, первый пустой - размер 10 байт, второй основной,
вроде без изменений и 3 - это стрим с маркерами.

```bash
remove_lanit2.pl file.pdf [out.pdf] [first_page]
```

red alitebooks.com
------------------

Alitebook превращает Contents в массив - добавляет 1 stream в начало и 3 streams добавляет
в конец. Сработало выдергивание из массива первого элемента и подстановка его в качестве
контента страницы.

Во втором файле - NSP.The ghidra books - первая страница уже была массивом - было несколько
стримов. Их можно определить по ссылочному номеру - добавленные элементы имеют большие номера.
Можно начать преобразование не с первой страницы, а первую страницу обработать вручную в iText-rups.

Кроме добавления надписи добавляет еще URL - $page->{Annots} - его тоже нужно удалять, в противном
случае остается рамка и курсор меняется.

```bash
remove_alitebook.pl file.pdf [out.pdf] [first_page]
```

удалить последний блок q\<block>Q
---------------------------------

Несколько файлов с добавленным в конец дополнительным блоком q..Q.

Сначала попытался добавить обработку странных вариантов с двойным блоком q..Q - оказалось,
что проблема в версии PDF в файле - Stream /XRef не обрабатывается
библиотекой CAM::PDF - выдает ошибку, слишком сложный поток для обработки.
После понижения версии PDF (оптимизированный файл для Acrobat 5.0) -  все заработало без дополнительных проверок.
Двойной блок убирается при оптимизации.

```bash
remove_last_block_q.pl file.pdf [out.pdf] [first_page]
```

scan page content
-----------------

Scan and remove string from the page content "/Lang (en-US)".
First need convert to the lover version PDF - 1.3 (Acrobat 4). Otherwise, get error - not compatible stream format!!

remove LastModified attribute from the page
-------------------------------------------

Scan all pages and remove single attribute LastModified.

ToDo
----

1. Вариант с одним скриптом и разными процедурами 	обработки - процедуру задаем через командную строку.
	Вынос процедур в отдельный модуль.
2. Расширение возможности задать страницы для 	обработки: диапазон начало-конец, четные-нечетные
3. Ланит - есть файлы, которые не обрабатываются корректно - по крайней мере 2, в которых картинка 	только на одной странице
4. Публикация модуля - английский readme.md