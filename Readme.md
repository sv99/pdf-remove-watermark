# pdf-remove-watermarks

__09.2020 - 09.2021__

Обработка PDF файлов при помощи [CAM::PDF](https://metacpan.org/pod/CAM::PDF).

CAM::PDF давно не обновляется, поддерживает только спецификацию pdf 1.3.
На более новых файлах вываливается с ошибкой при сохранении изменений.
Для работы нужно предварительно понизить версию, если это возможно.

Adobe PDF Reference versions 1.3, 1.4, and 1.7 in the doc folder.
На сайте Adobe очень сложно искать, возможно не знаю, что нужно спрашивать.
Загруженные файлы нашел по внешним ссылкам через Google.

remove_lanit.pl
---------------

Столкнулся с добавлением в хорошие файлы логотипов Ланит - по 2 штуки на страницу.

В разных файлах были добавлены по разному, но вылечилось отрезанием остатка из контекста страницы.
В конец были дописаны отображение чего-то. Конец определял по последнему вхождению ET.

После этого при оптимизации файла в Acrobat DC удаляются неиспользуемые картинки и ссылки.

```bash
remove_lanit.pl file.pdf [out.pdf] [first_page]
```
remove_lanit2.pl
----------------

Тот же Ланит, но контент состоит из массива из 3 стримов, первый пустой - размер 10 байт, второй основной,
вроде без изменений и 3 - это стрим с маркерами.

```bash
remove_lanit2.pl file.pdf [out.pdf] [first_page]
```

remove_alitebook.pl
------------------

Red alitebooks.com

Alitebook превращает Contents в массив - добавляет 1 stream в начало и 3 streams добавляет
в конец. Сработало выдергивание из массива первого элемента и подстановка его в качестве
контента страницы.

Во втором файле - NSP.The ghidra books - первая страница уже была массивом - было несколько
стримов. Их можно определить по ссылочному номеру - добавленные элементы имеют большие номера.
Можно начать преобразование не с первой страницы, а первую страницу обработать вручную в iText-rups.

Кроме добавления надписи добавляет еще URL - $page->{Annots} - его тоже нужно удалять, в противном
случае остается рамка и курсор меняется.

```bash
remove_alitebook.pl file.pdf [out.pdf] [first_page]
```

remove_last_block_q.pl
----------------------

Несколько файлов с добавленным в конец дополнительным блоком q..Q.

Сначала попытался добавить обработку странных вариантов с двойным блоком q..Q - оказалось,
что проблема в версии PDF в файле - Stream /XRef не обрабатывается
библиотекой CAM::PDF - выдает ошибку, слишком сложный поток для обработки.
После понижения версии PDF (оптимизированный файл для Acrobat 5.0) -  все заработало без дополнительных проверок.
Двойной блок убирается при оптимизации.

```bash
remove_last_block_q.pl file.pdf [out.pdf] [first_page]
```

remove_lang_from_content.pl
---------------------------

Scan and remove string from the page content "/Lang (en-US)".
First need convert to the lover version PDF - 1.3 (Acrobat 4). Otherwise, get error - not compatible stream format!!

remove_lastmodified.pl
----------------------

Scan all pages and remove single attribute LastModified.

ToDo
----

1. Вариант с одним скриптом и разными процедурами 	обработки - процедуру задаем через командную строку.
	Вынос процедур в отдельный модуль.
2. Расширение возможности задать страницы для 	обработки: диапазон начало-конец, четные-нечетные
3. Ланит - есть файлы, которые не обрабатываются корректно - по крайней мере 2, в которых картинка 	только на одной странице
4. Публикация модуля - английский readme.md